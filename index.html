<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Facturación</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { text-align: center; }
    .buscar { display: flex; justify-content: center; margin-bottom: 20px; gap: 10px; }
    input, button { padding: 8px; border: 1px solid #ccc; border-radius: 5px; }
    button { background: #4CAF50; color: white; cursor: pointer; }
    button:hover { background: #45a049; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f4f4f4; }
    .totales { text-align: right; margin-top: 20px; }
    .totales div { margin: 5px 0; }
    .qr-container { text-align: center; margin-top: 20px; }
  </style>
</head>
<body>
  <h2>Facturación</h2>

  <!-- Barra de búsqueda -->
  <div class="buscar">
    <input type="text" id="buscarInput" placeholder="Código o Nombre del producto">
    <button onclick="buscarProducto()">Buscar</button>
  </div>

  <!-- Prefacturación -->
  <div id="prefactura"></div>

  <!-- Cliente -->
  <div style="margin: 20px 0;">
    <input type="text" id="cliente" placeholder="Nombre del cliente" style="width: 100%; padding: 10px;">
  </div>

  <!-- Lista de productos a facturar -->
  <table>
    <thead>
      <tr>
        <th>Código</th>
        <th>Descripción</th>
        <th>Cantidad</th>
        <th>Precio Unitario</th>
        <th>ITBIS (18%)</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody id="tablaFactura"></tbody>
  </table>

  <!-- Totales -->
  <div class="totales">
    <div>Subtotal: <span id="subtotal">0</span></div>
    <div>ITBIS (18%): <span id="itbis">0</span></div>
    <div><strong>Total: <span id="total">0</span></strong></div>
  </div>

  <!-- Botón Facturar -->
  <div style="text-align:center; margin-top:20px;">
    <button onclick="facturar()">Facturar</button>
  </div>

  <!-- Contenedor QR -->
  <div class="qr-container" id="qrContainer"></div>
  
<!-- Planilla de ventas del día -->
<div style="margin-top: 40px; display: flex; justify-content: flex-start;">
  <div>
    <h3>Ventas del Día</h3>
    <table border="1" style="border-collapse: collapse; font-size: 14px;">
      <thead>
        <tr>
          <th>Descripción</th>
          <th>Cantidad</th>
          <th>Precio Unitario</th>
          <th>ITBIS (18%)</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody id="tablaVentasDia"></tbody>
    </table>
  </div>
</div>


  <!-- Librería QR -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <script>
    let productosFactura = [];
    let productoSeleccionado = null;

    async function buscarProducto() {
      const texto = document.getElementById("buscarInput").value.toLowerCase();
      if (!texto) { alert("Escriba código o nombre del producto"); return; }

      const res = await fetch('/productos');
      const productos = await res.json();

      const encontrado = productos.find(p => 
        p.codigo.toLowerCase() === texto || p.descripcion.toLowerCase().includes(texto)
      );

      if (encontrado) {
        productoSeleccionado = encontrado;
        document.getElementById("prefactura").innerHTML = `
          <h3>Prefacturación</h3>
          <p><b>Código:</b> ${encontrado.codigo} | <b>Descripción:</b> ${encontrado.descripcion} | <b>Precio:</b> ${encontrado.precio}</p>
          <input type="number" id="cantidadPrefactura" placeholder="Cantidad">
          <button onclick="agregarProducto()">Agregar Producto</button>
        `;
      } else {
        alert("Producto no encontrado");
      }
    }

    function agregarProducto() {
      const cantidad = parseInt(document.getElementById("cantidadPrefactura").value);
      if (!cantidad || cantidad <= 0) { alert("Ingrese una cantidad válida"); return; }

      const subtotal = cantidad * productoSeleccionado.precio;
      const itbis = subtotal * 0.18;
      const total = subtotal + itbis;

      productosFactura.push({
        codigo: productoSeleccionado.codigo,
        descripcion: productoSeleccionado.descripcion,
        cantidad,
        precio: productoSeleccionado.precio,
        subtotal,
        itbis,
        total
      });

      document.getElementById("prefactura").innerHTML = "";
      actualizarTabla();
    }

    function actualizarTabla() {
      const tabla = document.getElementById("tablaFactura");
      tabla.innerHTML = "";
      let subtotal = 0, itbis = 0, total = 0;

      productosFactura.forEach(p => {
        tabla.innerHTML += `
          <tr>
            <td>${p.codigo}</td>
            <td>${p.descripcion}</td>
            <td>${p.cantidad}</td>
            <td>${p.precio}</td>
            <td>${p.itbis.toFixed(2)}</td>
            <td>${p.total.toFixed(2)}</td>
          </tr>
        `;
        
        subtotal += p.subtotal;
        itbis += p.itbis;
        total += p.total;
      });
      
      
      document.getElementById("subtotal").innerText = subtotal.toFixed(2);
      document.getElementById("itbis").innerText = itbis.toFixed(2);
      document.getElementById("total").innerText = total.toFixed(2);
    }

    // Registrar en la planilla de ventas del día
productosFactura.forEach(p => {
  const fila = document.createElement("tr");
  fila.innerHTML = `
    <td>${p.descripcion}</td>
    <td>${p.cantidad}</td>
    <td>${Number(p.precio).toFixed(2)}</td>
    <td>${Number(p.itbis).toFixed(2)}</td>
    <td>${Number(p.total).toFixed(2)}</td>
  `;
  document.getElementById("tablaVentasDia").appendChild(fila);
});

// ... código anterior de la función facturar() ...
// ... código anterior de la función facturar() ...
async function facturar() {
  try {
    let cliente = (document.getElementById("cliente").value || "").trim();
    if (!cliente) cliente = "Consumidor Final";

    if (productosFactura.length === 0) { alert("No hay productos en la factura"); return; }

    // 1. Debitar inventario (se mantiene la lógica)
    for (let p of productosFactura) {
      try {
        await fetch('/debitar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ codigo: p.codigo, cantidad: p.cantidad })
        });
      } catch (e) {
        console.error("Error al debitar producto", p.codigo, e);
        // continuar con los otros productos
      }
    }
    
    // 2. Construir el objeto de datos para registrar la venta
    const subtotalGeneral = document.getElementById("subtotal") ? Number(document.getElementById("subtotal").innerText) : 0;
    const itbisGeneral = document.getElementById("itbis") ? Number(document.getElementById("itbis").innerText) : 0;
    const totalGeneral = document.getElementById("total") ? Number(document.getElementById("total").innerText) : 0;
    
    // Preparamos los datos mínimos requeridos de cada producto
    const productosParaRegistro = productosFactura.map(p => ({
        codigo: p.codigo,
        descripcion: p.descripcion,
        cantidad: p.cantidad,
        precio_unitario: p.precio,
        subtotal_producto: p.subtotal,
        itbis_producto: p.itbis,
        total_producto: p.total
    }));

    const datosVenta = {
        cliente: cliente,
        fecha: new Date().toLocaleString(),
        productos: productosParaRegistro,
        subtotal_general: subtotalGeneral,
        itbis_general: itbisGeneral,
        total_general: totalGeneral,
    };
    
    // 3. Enviar los datos al servidor Node.js
    const registroRes = await fetch('/registrar-venta', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(datosVenta)
    });

    if (!registroRes.ok) {
        throw new Error(`Error al registrar la venta: ${registroRes.statusText}`);
    }

    // 4. Continuar con la generación del QR (usando el formato anterior)
    
    // Construir URL con parámetros para el QR
    const fecha = encodeURIComponent(datosVenta.fecha);
    const clienteParam = encodeURIComponent(cliente);
    const subtotal = subtotalGeneral.toFixed(2);
    const itbis = itbisGeneral.toFixed(2);
    const total = totalGeneral.toFixed(2);

    let params = `cliente=${clienteParam}&fecha=${fecha}`;
    productosFactura.forEach((p, i) => {
      const prec = Number(p.precio || 0).toFixed(2);
      const itbisProd = Number(p.itbis || 0).toFixed(2); 
      params += `&p${i}=${encodeURIComponent(`${p.descripcion}*${p.cantidad}*${prec}*${itbisProd}`)}`;
    });
    
    params += `&subtotal=${encodeURIComponent(subtotal)}&itbis=${encodeURIComponent(itbis)}&total=${encodeURIComponent(total)}`;

    const urlIntermedia = `https://vivetelotvplay.github.io/CHAT-TV?${params}`;
window.location.href = urlIntermedia;

    
    // ... código para generar QR ...
    
    // Generar QR de forma robusta (código sin cambios, solo reubicado)
    const qrContainer = document.getElementById("qrContainer");
    qrContainer.innerHTML = "";
    try {
      if (typeof QRCode !== "undefined" && typeof QRCode.toCanvas === "function") {
        await new Promise((resolve, reject) => {
          QRCode.toCanvas(urlFactura, { width: 250 }, (err, canvas) => {
            if (err) return reject(err);
            qrContainer.appendChild(canvas);
            resolve();
          });
        });
      } else if (typeof QRCode !== "undefined" && typeof QRCode.toDataURL === "function") {
        const dataUrl = await new Promise((resolve, reject) => {
          QRCode.toDataURL(urlFactura, { width: 250 }, (err, url) => {
            if (err) return reject(err);
            resolve(url);
          });
        });
        const img = document.createElement('img');
        img.src = dataUrl;
        img.alt = "QR";
        qrContainer.appendChild(img);
      } else if (typeof QRCode !== "undefined") {
        try {
          new QRCode(qrContainer, { text: urlFactura, width: 250 });
        } catch (e) {
          throw e;
        }
      } else {
        throw new Error("Biblioteca QR no encontrada");
      }
    } catch (e) {
      console.error("Error generando QR:", e);
      alert("Ocurrió un error al generar el QR. Revisa la consola para más detalles.");
      return; // Detenemos si falla el QR
    }

    alert("Factura y QR generados con éxito. Venta registrada en el servidor.");
    // limpiar la lista de productos y refrescar tabla
    productosFactura = [];
    actualizarTabla();
  } catch (finalErr) {
    console.error("Error en facturar():", finalErr);
    alert(`Ocurrió un error inesperado. Revisa la consola. Detalle: ${finalErr.message}`);
  }
}

  </script>
</body>
</html>
